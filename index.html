<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Polygon to GeoJSON Mapper - Marin County</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #2c3e50, #3498db);
      color: white;
      padding: 20px;
      text-align: center;
    }
    #map { height: 500px; width: 100%; }
    .controls, .overlay-controls {
      padding: 15px 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }
    .btn {
      padding: 10px 20px;
      border-radius: 20px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-primary { background: #667eea; color: white; }
    .btn-success { background: #40c057; color: white; }
    .btn-danger { background: #ee5a52; color: white; }
    .output-section { padding: 20px; }
    #kmlOutput {
      width: 100%;
      height: 200px;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
  <!-- Leaflet -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <!-- Distortable Image plugin -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-distortableimage/dist/leaflet.distortableimage.css"/>
  <script src="https://unpkg.com/leaflet-distortableimage/dist/leaflet.distortableimage.js"></script>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üó∫Ô∏è Polygon to GeoJSON Mapper</h1>
    <p>Draw polygons on Marin County and export as GeoJSON</p>
  </div>

  <div class="overlay-controls">
    <input type="file" id="imageUpload" accept="image/*" />
    <label>Opacity: <input type="range" id="opacitySlider" min="0" max="100" value="70"></label>
  </div>

  <div class="controls">
    <button id="drawBtn" class="btn btn-primary">üé® Start Drawing</button>
    <button id="finishBtn" class="btn btn-success" disabled>‚úÖ Finish Polygon</button>
    <button id="clearBtn" class="btn btn-danger">üóëÔ∏è Clear All</button>
    <button id="exportBtn" class="btn btn-primary" disabled>üì• Generate GeoJSON</button>
  </div>

  <div id="map"></div>

  <div class="output-section">
    <h3>üìÑ GeoJSON Output</h3>
    <textarea id="kmlOutput" placeholder="Your GeoJSON will appear here..."></textarea>
  </div>
</div>

<script>
  // Init map
  const map = L.map('map').setView([38.0834, -122.7633], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  // State
  let isDrawing = false;
  let currentPolygonPoints = [];
  let allPolygons = [];
  let tempMarkers = [];
  let completedPolygonLayers = [];
  let imageOverlay = null;

  const drawBtn = document.getElementById('drawBtn');
  const finishBtn = document.getElementById('finishBtn');
  const clearBtn = document.getElementById('clearBtn');
  const exportBtn = document.getElementById('exportBtn');
  const kmlOutput = document.getElementById('kmlOutput');
  const imageUpload = document.getElementById('imageUpload');
  const opacitySlider = document.getElementById('opacitySlider');

  // Image upload with distortable plugin
  imageUpload.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      if (imageOverlay) map.removeLayer(imageOverlay);
      const corners = [
        L.latLng(37.8, -123.2),
        L.latLng(37.8, -122.3),
        L.latLng(38.4, -122.3),
        L.latLng(38.4, -123.2)
      ];
      imageOverlay = L.distortableImageOverlay(ev.target.result, {
        corners,
        opacity: opacitySlider.value / 100
      }).addTo(map);
    };
    reader.readAsDataURL(file);
  });

  opacitySlider.addEventListener('input', e => {
    if (imageOverlay) imageOverlay.setOpacity(e.target.value / 100);
  });

  // Drawing
  function handleMapClick(e) {
    if (!isDrawing) return;
    const lat = e.latlng.lat, lng = e.latlng.lng;
    currentPolygonPoints.push([lat, lng]);
    const marker = L.circleMarker([lat, lng], {radius: 4, color: '#ff6b6b'}).addTo(map);
    tempMarkers.push(marker);
    finishBtn.disabled = currentPolygonPoints.length < 3;
  }
  map.on('click', handleMapClick);

  drawBtn.addEventListener('click', () => {
    if (!isDrawing) {
      isDrawing = true;
      currentPolygonPoints = [];
      drawBtn.textContent = '‚è∏Ô∏è Stop Drawing';
    } else {
      isDrawing = false;
      drawBtn.textContent = 'üé® Start Drawing';
    }
  });

  finishBtn.addEventListener('click', () => {
    if (currentPolygonPoints.length < 3) return;
    const polygon = L.polygon(currentPolygonPoints, {
      color: '#667eea', fillColor: '#667eea', fillOpacity: 0.3
    }).addTo(map);
    completedPolygonLayers.push(polygon);
    allPolygons.push([...currentPolygonPoints]);
    tempMarkers.forEach(m => map.removeLayer(m));
    tempMarkers = [];
    currentPolygonPoints = [];
    finishBtn.disabled = true;
    exportBtn.disabled = false;
  });

  clearBtn.addEventListener('click', () => {
    completedPolygonLayers.forEach(l => map.removeLayer(l));
    completedPolygonLayers = [];
    tempMarkers.forEach(m => map.removeLayer(m));
    tempMarkers = [];
    allPolygons = [];
    currentPolygonPoints = [];
    kmlOutput.value = '';
    isDrawing = false;
    drawBtn.textContent = 'üé® Start Drawing';
    finishBtn.disabled = true;
    exportBtn.disabled = true;
  });

  // Export GeoJSON
  exportBtn.addEventListener('click', () => {
    if (!allPolygons.length) return;
    const geojson = {
      type: "FeatureCollection",
      features: allPolygons.map((polygon, i) => ({
        type: "Feature",
        properties: { name: `Polygon ${i + 1}` },
        geometry: {
          type: "Polygon",
          coordinates: [[
            ...polygon.map(pt => [pt[1], pt[0]]),
            [polygon[0][1], polygon[0][0]]
          ]]
        }
      }))
    };
    kmlOutput.value = JSON.stringify(geojson, null, 2);
    kmlOutput.select();
  });
</script>
</body>
</html>
